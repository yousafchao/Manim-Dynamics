from manim import *
from mylib.systems.lorenz import simulate, ramp, constant_force
from mylib.attractors.lorenz_viz import (
    conclusion_box,
    shake_animation,
    make_axes, equation_block, title_tag, watermark, acknowledgement,
    status_box, segmented_curve, center_shift_from_points
)

def park_snapshot(mob: Mobject, label: str, offset: np.ndarray):
    tag = Text(label, font_size=28, weight=BOLD, color=WHITE).set_opacity(0.85)
    tag.next_to(mob, DOWN, buff=0.25)
    return VGroup(mob, tag).shift(offset)

class LorenzAnesthesiaScene(ThreeDScene):
    def construct(self):
        DT = 0.01
        COLOR_PERIOD = 20.0

        BASELINE_PRE = 20.0
        AGENT_T = 50.0
        PERT_PAUSE = 10.0
        DEVIATE_T = 100.0
        RECOVER_T = 50.0

        SIGMA = 10.0
        BETA = 8.0 / 3.0
        RHO_WAKE = 40.0
        RHO_ANES = 65.0

        display_scale = 0.5

        ax = make_axes()
        self.set_camera_orientation(phi=65 * DEGREES, theta=-45 * DEGREES, zoom=1.25)
        self.begin_ambient_camera_rotation(rate=0.10)

        eq = equation_block()
        title = title_tag("Anesthesia state")
        w = watermark()
        ack = acknowledgement()
concl = conclusion_box()
        hud = status_box("Baseline", include_agent=True)

        self.add(ax)
        self.add_fixed_in_frame_mobjects(eq, title, w, ack, hud, concl)

        ptsA, sA = simulate(
            s0=(0.0, 1.0, 1.05),
            duration=BASELINE_PRE,
            dt=DT,
            sigma=SIGMA,
            rho=RHO_WAKE,
            beta=BETA,
            burn_in=2.0,
            force=None,
        )
        shift_center = center_shift_from_points(ax, ptsA, display_scale=display_scale)

        segA, runA = segmented_curve(ax, ptsA, DT, seg_seconds=COLOR_PERIOD, display_scale=display_scale, extra_shift=shift_center)
        grpA = VGroup()
        for seg, rt in zip(segA, runA):
            self.play(Create(seg), run_time=rt, rate_func=linear)
            grpA.add(seg)

        R = 3.2
        SLOT_180 = LEFT * R
        SLOT_90 = UP * R
        SLOT_270 = DOWN * R

        new_hud_agent = status_box("Anesthesia Agent", include_agent=True)
        parkedA = park_snapshot(grpA, "Baseline", offset=SLOT_180)

        self.play(
            AnimationGroup(
                Transform(hud, new_hud_agent),
                Transform(grpA, parkedA[0]),
                FadeIn(parkedA[1], shift=DOWN * 0.05),
                lag_ratio=0,
            ),
            shake_animation(run_time=1.8,
        )

        rho_fn = ramp(RHO_WAKE, RHO_ANES, t0=0.0, t1=10.0)
        ptsB, sB = simulate(
            s0=sA,
            duration=AGENT_T,
            dt=DT,
            sigma=SIGMA,
            rho=rho_fn,
            beta=BETA,
            burn_in=0.0,
            force=None,
        )
        segB, runB = segmented_curve(ax, ptsB, DT, seg_seconds=COLOR_PERIOD, display_scale=display_scale, extra_shift=shift_center)
        grpB = VGroup()
        for seg, rt in zip(segB, runB):
            self.play(Create(seg), run_time=rt, rate_func=linear)
            grpB.add(seg)

        new_hud_pert = status_box("Perturbation", include_agent=True)
        parkedB = park_snapshot(grpB, "Anesthesia Agent", offset=SLOT_90)

        self.play(
            AnimationGroup(
                Transform(hud, new_hud_pert),
                ApplyMethod(ax.shift, RIGHT * 0.14, rate_func=there_and_back),
                Transform(grpB, parkedB[0]),
                FadeIn(parkedB[1], shift=DOWN * 0.05),
                lag_ratio=0,
            ),
            shake_animation(run_time=1.8,
        )

        self.wait(max(0.0, PERT_PAUSE - 1.0))

        force = constant_force(vec=(3.0, 0.0, 1.5))
        ptsC, sC = simulate(
            s0=sB,
            duration=DEVIATE_T,
            dt=DT,
            sigma=SIGMA,
            rho=RHO_ANES,
            beta=BETA,
            burn_in=0.0,
            force=force,
        )
        segC, runC = segmented_curve(ax, ptsC, DT, seg_seconds=COLOR_PERIOD, display_scale=display_scale, extra_shift=shift_center)
        grpC = VGroup()
        for seg, rt in zip(segC, runC):
            self.play(Create(seg), run_time=rt, rate_func=linear)
            grpC.add(seg)

        new_hud_base = status_box("Baseline", include_agent=True)
        parkedC = park_snapshot(grpC, "Perturbation", offset=SLOT_270)

        self.play(
            AnimationGroup(
                Transform(hud, new_hud_base),
                Transform(grpC, parkedC[0]),
                FadeIn(parkedC[1], shift=DOWN * 0.05),
                lag_ratio=0,
            ),
            shake_animation(run_time=1.8,
        )

        rho_back = ramp(RHO_ANES, RHO_WAKE, t0=0.0, t1=10.0)
        ptsD, _ = simulate(
            s0=sC,
            duration=RECOVER_T,
            dt=DT,
            sigma=SIGMA,
            rho=rho_back,
            beta=BETA,
            burn_in=0.0,
            force=None,
        )
        segD, runD = segmented_curve(ax, ptsD, DT, seg_seconds=COLOR_PERIOD, display_scale=display_scale, extra_shift=shift_center)
        for seg, rt in zip(segD, runD):
            self.play(Create(seg), run_time=rt, rate_func=linear)

        self.wait(1)
